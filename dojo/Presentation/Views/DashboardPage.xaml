<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:Presentation.ViewModels"
             xmlns:models="clr-namespace:Presentation.Models"
             xmlns:dalmodels="clr-namespace:DAL.Models;assembly=DAL"
             xmlns:controls="clr-namespace:Presentation.Controls"
             x:Class="Presentation.Views.DashboardPage"
             BackgroundColor="#F5F5F5">

    <Grid RowDefinitions="60,*" ColumnDefinitions="*,340">
        
        <!-- Top Toolbar -->
        <Border 
            Grid.Row="0" 
            Grid.ColumnSpan="2"
            BackgroundColor="White"
            Shadow="{Shadow Brush=Black, Opacity=0.1, Radius=5, Offset='0,2'}">
            <Grid Padding="15,0" ColumnDefinitions="Auto,*,Auto">
                
                <!-- Left Buttons -->
                <HorizontalStackLayout Grid.Column="0" Spacing="10">
                    <Button 
                        Text="+ Ð”Ð¾Ð´Ð°Ñ‚Ð¸ Ð¿Ð»Ð°Ð½"
                        Command="{Binding AddPlanCommand}"
                        Style="{StaticResource PrimaryButtonStyle}"
                        Padding="15,8"/>
                    
                    <Button 
                        Text="ðŸ“‹ TODO"
                        Command="{Binding OpenTodoPopupCommand}"
                        Style="{StaticResource OutlineButtonStyle}"
                        Padding="12,8"/>
                </HorizontalStackLayout>

                <!-- Center - Date Navigation -->
                <HorizontalStackLayout 
                    Grid.Column="1" 
                    Spacing="15"
                    HorizontalOptions="Center"
                    VerticalOptions="Center">
                    
                    <Button 
                        Text="â—€"
                        Command="{Binding NavigatePreviousCommand}"
                        Style="{StaticResource ArrowButtonStyle}"/>
                    
                    <Label 
                        Text="{Binding DateRangeText}"
                        FontSize="18"
                        FontAttributes="Bold"
                        VerticalOptions="Center"
                        TextColor="#333"/>
                    
                    <Button 
                        Text="â–¶"
                        Command="{Binding NavigateNextCommand}"
                        Style="{StaticResource ArrowButtonStyle}"/>
                </HorizontalStackLayout>

                <!-- Right - View Mode and Profile -->
                <HorizontalStackLayout Grid.Column="2" Spacing="10">
                    <!-- Profile Icon -->
                    <Border 
                        Style="{StaticResource ProfileBorderStyle}"
                        VerticalOptions="Center">
                        <Label 
                            Text="{Binding UserInitials}"
                            FontSize="16"
                            FontAttributes="Bold"
                            TextColor="White"
                            HorizontalOptions="Center"
                            VerticalOptions="Center"/>
                        <Border.GestureRecognizers >
                            <TapGestureRecognizer Tapped="OnProfileTapped"/>
                        </Border.GestureRecognizers>
                    </Border>

                    <Label 
                        Text="{Binding UserName}"
                        FontSize="14"
                        FontAttributes="Bold"
                        TextColor="#333"
                        VerticalOptions="Center"
                        Margin="0,0,15,0"/>

                    <Border 
                        BackgroundColor="#F0F0F0"
                        Padding="2"
                        StrokeShape="RoundRectangle 5"
                        Stroke="Transparent">
                        <HorizontalStackLayout Spacing="0">
                            <Button 
                                Text="Ð”ÐµÐ½ÑŒ"
                                Command="{Binding ChangeModeCommand}"
                                CommandParameter="Day"
                                Style="{StaticResource ViewModeButtonStyle}"
                                BackgroundColor="{Binding CurrentViewMode, Converter={StaticResource ViewModeToColorConverter}, ConverterParameter=Day}"
                                TextColor="{Binding CurrentViewMode, Converter={StaticResource ViewModeToTextColorConverter}, ConverterParameter=Day}"/>
                            <Button 
                                Text="Ð¢Ð¸Ð¶Ð´ÐµÐ½ÑŒ"
                                Command="{Binding ChangeModeCommand}"
                                CommandParameter="Week"
                                Style="{StaticResource ViewModeButtonStyle}"
                                BackgroundColor="{Binding CurrentViewMode, Converter={StaticResource ViewModeToColorConverter}, ConverterParameter=Week}"
                                TextColor="{Binding CurrentViewMode, Converter={StaticResource ViewModeToTextColorConverter}, ConverterParameter=Week}"/>
                            <Button 
                                Text="ÐœÑ–ÑÑÑ†ÑŒ"
                                Command="{Binding ChangeModeCommand}"
                                CommandParameter="Month"
                                Style="{StaticResource ViewModeButtonStyle}"
                                BackgroundColor="{Binding CurrentViewMode, Converter={StaticResource ViewModeToColorConverter}, ConverterParameter=Month}"
                                TextColor="{Binding CurrentViewMode, Converter={StaticResource ViewModeToTextColorConverter}, ConverterParameter=Month}"/>
                        </HorizontalStackLayout>
                    </Border>
                    
                    <Button 
                        Text="Ð¡ÑŒÐ¾Ð³Ð¾Ð´Ð½Ñ–"
                        Command="{Binding GoToTodayCommand}"
                        Style="{StaticResource SecondaryButtonStyle}"
                        Padding="12,8"/>
                </HorizontalStackLayout>
            </Grid>
        </Border>

        <!-- Main Content Area -->
        <Grid Grid.Row="1" Grid.Column="0" Padding="10">
            <ScrollView>
                <VerticalStackLayout Spacing="15">
                    
                    <!-- Day Schedule Grid -->
                    <ScrollView 
                        HeightRequest="600"
                        IsVisible="{Binding CurrentViewMode, Converter={StaticResource ViewModeToVisibilityConverter}, ConverterParameter=Day}">
                        <Border 
                            BackgroundColor="White"
                            Stroke="#E0E0E0"
                            StrokeThickness="1"
                            Padding="0"
                            StrokeShape="RoundRectangle 8">
                            <controls:DayScheduleGrid 
                                x:Name="DaySchedule"
                                Events="{Binding Events}"
                                SelectedDate="{Binding SelectedDate}"/>
                        </Border>
                    </ScrollView>
                    
                    <!-- Week Schedule Grid -->
                    <Border 
                        BackgroundColor="White"
                        Stroke="#E0E0E0"
                        StrokeThickness="1"
                        Padding="0"
                        StrokeShape="RoundRectangle 8"
                        HeightRequest="600"
                        IsVisible="{Binding CurrentViewMode, Converter={StaticResource ViewModeToVisibilityConverter}, ConverterParameter=Week}">
                        <controls:WeekScheduleGrid 
                            x:Name="WeekSchedule"
                            Events="{Binding Events}"
                            WeekStartDate="{Binding WeekStartDate}"/>
                    </Border>

                    <!-- Month View Grid -->
                    <Border 
                        BackgroundColor="White"
                        Stroke="#E0E0E0"
                        StrokeThickness="1"
                        Padding="10"
                        StrokeShape="RoundRectangle 8"
                        IsVisible="{Binding CurrentViewMode, Converter={StaticResource ViewModeToVisibilityConverter}, ConverterParameter=Month}">
                        <controls:MonthViewGrid 
                            x:Name="MonthView"
                            Events="{Binding Events}"
                            SelectedDate="{Binding SelectedDate}"/>
                    </Border>

                    <!-- Bottom Cards Row -->
                    <Grid ColumnDefinitions="*,*,*" ColumnSpacing="15">
                        
                        <!-- Plan Card -->
                        <Border 
                            Grid.Column="0"
                            BackgroundColor="White"
                            Stroke="#E0E0E0"
                            StrokeThickness="1"
                            Padding="15"
                            StrokeShape="RoundRectangle 8">
                            <VerticalStackLayout Spacing="10">
                                <Label 
                                    Text="ðŸ“‹ ÐŸÐ›ÐÐ"
                                    FontSize="16"
                                    FontAttributes="Bold"
                                    TextColor="#333"/>
                                
                                <CollectionView ItemsSource="{Binding SortedEvents}">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="models:EventModel">
                                            <Grid ColumnDefinitions="Auto,*,Auto" Padding="0,5" ColumnSpacing="8">
                                                <CheckBox 
                                                    Grid.Column="0"
                                                    IsChecked="{Binding IsCompleted}"
                                                    CheckedChanged="OnPlanCheckChanged"
                                                    VerticalOptions="Center"/>
                                                <Label 
                                                    Grid.Column="1"
                                                    Text="{Binding Title}"
                                                    FontSize="14"
                                                    VerticalOptions="Center"
                                                    TextColor="{Binding IsCompleted, Converter={StaticResource BoolToGrayTextConverter}}"
                                                    TextDecorations="{Binding IsCompleted, Converter={StaticResource BoolToTextDecorationConverter}}"/>
                                                <Label 
                                                    Grid.Column="2"
                                                    Text="{Binding EndDateTime, StringFormat='{0:dd.MM}'}"
                                                    FontSize="11"
                                                    TextColor="#E53935"
                                                    VerticalOptions="Center"
                                                    FontAttributes="Bold"/>
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </VerticalStackLayout>
                        </Border>

                        <!-- To Do Card -->
                        <Border 
                            Grid.Column="1"
                            BackgroundColor="White"
                            Stroke="#E0E0E0"
                            StrokeThickness="1"
                            Padding="15"
                            StrokeShape="RoundRectangle 8">
                            <VerticalStackLayout Spacing="10">
                                <Label 
                                    Text="âœ“ TO DO"
                                    FontSize="16"
                                    FontAttributes="Bold"
                                    TextColor="#333"/>
                                
                                <CollectionView ItemsSource="{Binding TodoTasksFromDb}">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="dalmodels:ToDoTask">
                                            <Border 
                                                Padding="8,5"
                                                Margin="0,3"
                                                BackgroundColor="Transparent"
                                                StrokeShape="RoundRectangle 4"
                                                Stroke="Transparent">
                                                <Grid ColumnDefinitions="Auto,*">
                                                    <CheckBox 
                                                        Grid.Column="0"
                                                        IsChecked="{Binding IsCompleted}"
                                                        Color="#FF69B4">
                                                        <CheckBox.GestureRecognizers>
                                                            <TapGestureRecognizer 
                                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=ToggleTodoTaskCommand}"
                                                                CommandParameter="{Binding . }"/>
                                                        </CheckBox.GestureRecognizers>
                                                    </CheckBox>
                                                    
                                                    <VerticalStackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center" Margin="5,0,0,0">
                                                        <Label 
                                                            Text="{Binding Description}"
                                                            FontSize="14"
                                                            FontAttributes="Bold"
                                                            TextColor="#333"
                                                            LineBreakMode="HeadTruncation"
                                                            MaxLines="1"/>
                                                        <Label 
                                                            Text="{Binding Priority, StringFormat='ðŸ”¥ ÐŸÑ€Ñ–Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚: {0}'}"
                                                            FontSize="11"
                                                            TextColor="#FF69B4"
                                                            FontAttributes="Bold"/>
                                                    </VerticalStackLayout>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                                
                                <Button 
                                    Text="+ Ð”Ð¾Ð´Ð°Ñ‚Ð¸ Ð·Ð°Ð²Ð´Ð°Ð½Ð½Ñ"
                                    Command="{Binding OpenTodoPopupCommand}"
                                    Style="{StaticResource AddButtonStyle}"/>
                            </VerticalStackLayout>
                        </Border>

                        <!-- Statistics Card -->
                        <Border 
                            Grid.Column="2"
                            BackgroundColor="White"
                            Stroke="#E0E0E0"
                            StrokeThickness="1"
                            Padding="15"
                            StrokeShape="RoundRectangle 8">
                            <VerticalStackLayout Spacing="10">
                                <Label 
                                    Text="ðŸ“Š Ð¡Ð¢ÐÐ¢Ð˜Ð¡Ð¢Ð˜ÐšÐ"
                                    FontSize="16"
                                    FontAttributes="Bold"
                                    TextColor="#333"/>
        
                                <Label 
                                    Text="{Binding CompletedTasksCount, StringFormat='Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾ Ð·Ð°Ð²Ð´Ð°Ð½ÑŒ: {0}'}"
                                    FontSize="14"
                                    TextColor="#666"/>
        
                                <Label 
                                    Text="{Binding TotalWorkHours, StringFormat='Ð§Ð°Ñ Ñ€Ð¾Ð±Ð¾Ñ‚Ð¸: {0:F1} Ð³Ð¾Ð´'}"
                                    FontSize="14"
                                    TextColor="#666"/>
        
                                <Label 
                                    Text="{Binding ProductivityPercentage, StringFormat='ÐŸÑ€Ð¾Ð´ÑƒÐºÑ‚Ð¸Ð²Ð½Ñ–ÑÑ‚ÑŒ: {0:F0}%'}"
                                    FontSize="14"
                                    TextColor="#666"/>
        
                                <Button 
                                    Text="Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ–ÑˆÐµ"
                                    Command="{Binding NavigateToStatisticsCommand}"
                                    Style="{StaticResource SecondaryButtonStyle}"
                                    Padding="10,5"
                                    FontSize="12"
                                    Margin="0,10,0,0"/>
                            </VerticalStackLayout>
                        </Border>
                    </Grid>
                </VerticalStackLayout>
            </ScrollView>
        </Grid>

        <!-- Right Sidebar -->
        <Border 
            Grid.Row="1" 
            Grid.Column="1"
            BackgroundColor="White"
            Stroke="#E0E0E0"
            StrokeThickness="1"
            Padding="15"
            Margin="0,10,10,10"
            StrokeShape="RoundRectangle 8">
            <VerticalStackLayout Spacing="20">
                
                <!-- Mini Calendar -->
                <VerticalStackLayout Spacing="10">
                    <Label 
                        Text="ðŸ“… ÐšÐ°Ð»ÐµÐ½Ð´Ð°Ñ€"
                        FontSize="16"
                        FontAttributes="Bold"
                        TextColor="#333"/>
                    
                    <Border 
                        BackgroundColor="White"
                        Padding="12,12"
                        StrokeShape="RoundRectangle 8"
                        Stroke="#E0E0E0"
                        StrokeThickness="1">
                        <VerticalStackLayout Spacing="10">
                            <!-- Calendar Header with Month/Year -->
                            <HorizontalStackLayout HorizontalOptions="Center" Spacing="10">
                                <Button 
                                    Text="â—€"
                                    BackgroundColor="Transparent"
                                    TextColor="#666"
                                    FontSize="14"
                                    WidthRequest="30"
                                    HeightRequest="30"
                                    Padding="0"
                                    Command="{Binding PreviousMonthCommand}"/>
                                
                                <Label 
                                    Text="{Binding CurrentMonthYear}"
                                    FontSize="14"
                                    FontAttributes="Bold"
                                    TextColor="#333"
                                    VerticalOptions="Center"
                                    MinimumWidthRequest="120"
                                    HorizontalTextAlignment="Center"/>
                                
                                <Button 
                                    Text="â–¶"
                                    BackgroundColor="Transparent"
                                    TextColor="#666"
                                    FontSize="14"
                                    WidthRequest="30"
                                    HeightRequest="30"
                                    Padding="0"
                                    Command="{Binding NextMonthCommand}"/>
                            </HorizontalStackLayout>
                            
                            <!-- Days of Week Header -->
                            <Grid ColumnDefinitions="*,*,*,*,*,*,*" ColumnSpacing="2" Margin="0,5,0,5">
                                <Label Grid.Column="0" Text="ÐŸÐ½" FontSize="10" TextColor="#999" HorizontalTextAlignment="Center" FontAttributes="Bold"/>
                                <Label Grid.Column="1" Text="Ð’Ñ‚" FontSize="10" TextColor="#999" HorizontalTextAlignment="Center" FontAttributes="Bold"/>
                                <Label Grid.Column="2" Text="Ð¡Ñ€" FontSize="10" TextColor="#999" HorizontalTextAlignment="Center" FontAttributes="Bold"/>
                                <Label Grid.Column="3" Text="Ð§Ñ‚" FontSize="10" TextColor="#999" HorizontalTextAlignment="Center" FontAttributes="Bold"/>
                                <Label Grid.Column="4" Text="ÐŸÑ‚" FontSize="10" TextColor="#999" HorizontalTextAlignment="Center" FontAttributes="Bold"/>
                                <Label Grid.Column="5" Text="Ð¡Ð±" FontSize="10" TextColor="#E91E63" HorizontalTextAlignment="Center" FontAttributes="Bold"/>
                                <Label Grid.Column="6" Text="ÐÐ´" FontSize="10" TextColor="#E91E63" HorizontalTextAlignment="Center" FontAttributes="Bold"/>
                            </Grid>
                            
                            <!-- Calendar Days Grid -->
                            <CollectionView 
                                ItemsSource="{Binding CalendarDays}"
                                SelectionMode="Single"
                                SelectedItem="{Binding SelectedCalendarDay}"
                                SelectionChanged="OnCalendarDaySelectionChanged"
                                HeightRequest="240"
                                HorizontalOptions="Center">
                                <CollectionView.ItemsLayout>
                                    <GridItemsLayout 
                                        Orientation="Vertical" 
                                        Span="7"
                                        HorizontalItemSpacing="2"
                                        VerticalItemSpacing="3"/>
                                </CollectionView.ItemsLayout>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:CalendarDayModel">
                                        <Border 
                                            BackgroundColor="{Binding BackgroundColor}"
                                            Padding="4"
                                            HeightRequest="40"
                                            WidthRequest="40"
                                            StrokeShape="RoundRectangle 4"
                                            Stroke="{Binding BorderColor}"
                                            StrokeThickness="1"
                                            HorizontalOptions="Fill"
                                            VerticalOptions="Fill">
                                            <Grid>
                                                <Label 
                                                    Text="{Binding Day}"
                                                    FontSize="12"
                                                    TextColor="{Binding TextColor}"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Center"
                                                    FontAttributes="{Binding FontAttributes}"/>
                                                <!-- Event Indicator Dot -->
                                                <Ellipse 
                                                    Fill="{Binding EventDotColor}"
                                                    WidthRequest="4"
                                                    HeightRequest="4"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="End"
                                                    Margin="0,0,0,3"
                                                    IsVisible="{Binding ShowEventDot}"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>
                </VerticalStackLayout>

                <!-- Pomodoro Timer -->
                <VerticalStackLayout Spacing="10">
                    <Label 
                        Text="â±ï¸ ÐŸÐ¾Ð¼Ð¾Ð´Ð¾Ñ€Ð¾"
                        FontSize="16"
                        FontAttributes="Bold"
                        TextColor="#333"/>
                    
                    <Border 
                        BackgroundColor="#FFF3E0"
                        Padding="20"
                        StrokeShape="RoundRectangle 8"
                        Stroke="#FFB74D">
                        <VerticalStackLayout Spacing="10" HorizontalOptions="Center">
                            <Label 
                                Text="{Binding PomodoroTimeText}"
                                FontSize="32"
                                FontAttributes="Bold"
                                HorizontalOptions="Center"
                                TextColor="{StaticResource Raspberry}"/>
                            
                            <HorizontalStackLayout Spacing="15" HorizontalOptions="Center">
                                <Button 
                                    Text="{Binding TimerButtonText}"
                                    BackgroundColor="{StaticResource HotPink}"
                                    Style="{StaticResource PomodoroButtonStyle}"
                                    Command="{Binding StartPomodoroCommand}"/>
                                <Button 
                                    Text="â†»"
                                    BackgroundColor="#F44336"
                                    Style="{StaticResource PomodoroButtonStyle}"
                                    Command="{Binding ResetPomodoroCommand}"/>
                            </HorizontalStackLayout>
                        </VerticalStackLayout>
                    </Border>
                </VerticalStackLayout>

                <!-- Mascot -->
                <VerticalStackLayout Spacing="10">
                    <Label 
                        Text="ðŸ· Ð¢Ð²Ñ–Ð¹ Ð³ÐµÑ€Ð¾Ð¹"
                        FontSize="16"
                        FontAttributes="Bold"
                        TextColor="#333"/>
                    
                    <Border 
                        BackgroundColor="{StaticResource SoftPink}"
                        Padding="20"
                        StrokeShape="RoundRectangle 12"
                        Stroke="{StaticResource HotPink}"
                        StrokeThickness="2"
                        HeightRequest="180">
                        <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="10">
                            <!-- Ð¡Ð²Ð¸Ð½ÐºÐ° -->
                            <Label 
                                Text="(^_^)"
                                FontSize="48"
                                HorizontalOptions="Center"
                                TextColor="{StaticResource HotPink}"
                                Margin="0,0,0,5"/>
                            
                            <!-- ðŸ”¥ Ð”Ð˜ÐÐÐœÐ†Ð§ÐÐ˜Ð™ Ð Ð†Ð’Ð•ÐÐ¬ -->
                            <Label 
                                Text="{Binding UserLevel, StringFormat='Ð Ñ–Ð²ÐµÐ½ÑŒ {0}'}"
                                FontSize="18"
                                HorizontalOptions="Center"
                                TextColor="{StaticResource HotPink}"
                                FontAttributes="Bold"/>
                            
                            <!-- ðŸ”¥ ÐŸÐ ÐžÐ“Ð Ð•Ð¡-Ð‘ÐÐ  Ð— ÐžÐ‘Ð“ÐžÐ Ð¢ÐšÐžÐ® -->
                            <Border
                                BackgroundColor="#E0E0E0"
                                StrokeShape="RoundRectangle 8"
                                Stroke="Transparent"
                                HeightRequest="12"
                                WidthRequest="200"
                                Padding="0"
                                Margin="0,5,0,5">
                                <ProgressBar 
                                    Progress="{Binding UserProgressPercent}"
                                    ProgressColor="{StaticResource HotPink}"
                                    HeightRequest="12"
                                    VerticalOptions="Fill"
                                    HorizontalOptions="Fill"/>
                            </Border>
                            
                            <!-- ðŸ”¥ Ð”Ð˜ÐÐÐœÐ†Ð§ÐÐ˜Ð™ Ð¢Ð•ÐšÐ¡Ð¢ Ð”ÐžÐ¡Ð’Ð†Ð”Ð£ -->
                            <Label 
                                Text="{Binding UserExpProgressText}"
                                FontSize="14"
                                HorizontalOptions="Center"
                                TextColor="#666"
                                FontAttributes="Bold"/>
                        </VerticalStackLayout>
                    </Border>
                </VerticalStackLayout>

            </VerticalStackLayout>
        </Border>

    </Grid>

</ContentPage>